{% sw_extends '@Storefront/storefront/layout/meta.html.twig' %}

{% block layout_head_meta_tags %}
    {% set instanceKey = page.extensions.twConfiguration.instanceKey|escape %}
    {% set languageKey = (page.header.activeLanguage.translationCode.code ?? context.languageInfo.localeCode)|split('-')[0]|escape %}
    {% set wayOfSearch = page.extensions.twConfiguration.wayOfSearch|escape %}

    {{ parent() }}

    {% block tweakwise_config %}
        {% if page.extensions.twConfiguration.integration == 'pluginstudio' %}
            {% sw_include '@Storefront/storefront/layout/tweakwise/pluginstudio.html.twig' %}
        {% endif %}

        {% if page.extensions.twConfiguration.integration == 'javascript' %}
            {% if instanceKey %}
                {% if wayOfSearch == 'suggestions' %}
                    {% sw_include '@Storefront/storefront/layout/tweakwise/suggestions.html.twig' %}
                {% endif %}

                {% sw_include '@Storefront/storefront/layout/tweakwise/instant-search.html.twig' %}

            {% endif %}

            <script
                    src="https://gateway.tweakwisenavigator.net/js/recommendations.js"
                    data-failover="https://gateway.tweakwisenavigator.com/js/recommendations.js"
                    onerror="window.tweakwiseFailover(this.dataset.failover)"
            ></script>
        {% endif %}

        {% if instanceKey %}
            <script>
                (function () {
                    window.tweakwise = window.tweakwise || {};
                    if (typeof window.tweakwise.getProfileKey === 'function') return;

                    window.tweakwise.getProfileKey = function () {
                        const cached = window.sessionStorage.getItem('tweakwise_profile_key');
                        if (cached) return Promise.resolve(cached);

                        return fetch('/tweakwise/profile-key', {
                            credentials: 'same-origin',
                            headers: { 'Accept': 'application/json' }
                        })
                            .then(r => {
                                if (!r.ok) throw new Error('Failed to load profile key (' + r.status + ')');
                                return r.json();
                            })
                            .then(json => {
                                window.sessionStorage.setItem('tweakwise_profile_key', json.profileKey);
                                return json.profileKey;
                            });
                    };
                })();
            </script>


            <script>
                let tweakwiseProductId;
                window.tweakwiseConfig = window.tweakwiseConfig || {};
                window.tweakwiseConfig.instanceKey = '{{ instanceKey }}';
            </script>
        {% endif %}
    {% endblock %}
{% endblock %}
