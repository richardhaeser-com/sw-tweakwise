{% sw_extends '@Storefront/storefront/page/checkout/finish/index.html.twig' %}

{% block page_checkout_main_content %}
    {% if page.extensions.twConfiguration.eventTagEnabled %}
        {% set tweakwiseBoughtItems = [] %}
        {% for item in page.order.nestedLineItems %}
            {% if item.payload.productNumber %}
                {% set product = tweakwise_product_id_by_product_number(item.payload.productNumber, context.domainId) %}
                {% if product %}
                    {% set tweakwiseBoughtItems = tweakwiseBoughtItems|merge([product]) %}
                {% endif %}
            {% endif %}
        {% endfor %}

        {% set revenue = 0 %}
        {% if page.order.amountNet %}
            {% set revenue = page.order.amountNet %}
        {% endif %}

        <script>
            (async () => {
                window.tweakwiseLayer = window.tweakwiseLayer || [];

                const profileKey = await window.tweakwise.getProfileKey();

                window.tweakwiseLayer.push({
                    event: 'purchase',
                    data: {
                        profileKey: profileKey,
                        productKeys: [{{ tweakwiseBoughtItems|map(i => '"' ~ i ~ '"')|join(',')|raw }}],
                        revenue: {{ revenue|floatval }}
                    }
                });
            })();
        </script>
    {% endif %}

    {{ parent() }}
{% endblock %}