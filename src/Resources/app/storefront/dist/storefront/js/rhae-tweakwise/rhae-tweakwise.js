(()=>{"use strict";class t{static iterate(t,e){if(t instanceof Map||Array.isArray(t))return t.forEach(e);if(t instanceof FormData){for(var i of t.entries())e(i[1],i[0]);return}if(t instanceof NodeList)return t.forEach(e);if(t instanceof HTMLCollection)return Array.from(t).forEach(e);if(t instanceof Object)return Object.keys(t).forEach(i=>{e(t[i],i)});throw Error(`The element type ${typeof t} is not iterable!`)}}class e{static serialize(t){let e=!(arguments.length>1)||void 0===arguments[1]||arguments[1];if("FORM"!==t.nodeName){if(e)throw Error("The passed element is not a form!");return{}}return new FormData(t)}static serializeJson(t){let i=!(arguments.length>1)||void 0===arguments[1]||arguments[1],r=e.serialize(t,i);if(!(r instanceof FormData)&&0===Object.keys(r).length||r instanceof FormData&&0===Array.from(r.entries()).length)return{};let a={};for(let[t,e]of r.entries())a[t]=e;return a}}let i=window.PluginBaseClass;window.PluginManager;class r extends i{init(){this._registerEvents()}_registerEvents(){let t=this._addToCart.bind(this);window.addEventListener("twAddToCart",t),document.addEventListener("submit",t=>{if("undefined"==typeof tweakwiseProductId||!tweakwiseProductId)return;let e=t.target.closest('.is-ctl-product form[data-add-to-cart="true"]');if(!e)return;let i=this._extractAddToCartData(e);this._fireEventTag(i)},!0)}_extractShopwareUUID(t){let e=t.match(/-([a-f0-9]{32})$/i);return e?e[1]:null}_addToCart(t){let i=this._extractShopwareUUID(t.detail.data.itemno);if(!i){console.log("Not a valid product id given",t.detail.itemno);return}let r=document.createElement("form");r.dataset.addToCart="true",r.setAttribute("action",t.detail.addToCartAction),r.setAttribute("method","post"),r.setAttribute("id","twn-add-to-cart-form"),r.setAttribute("data-add-to-cart","true");let a=document.createElement("input");a.setAttribute("type","hidden"),a.setAttribute("name","redirectTo"),a.setAttribute("value","frontend.cart.offcanvas");let n=document.createElement("input");n.setAttribute("type","hidden"),n.setAttribute("name","redirectParameters"),n.dataset.redirectParameters="true",n.setAttribute("value",'{"productId": "'+i+'"}');let s=document.createElement("input");s.setAttribute("type","hidden"),s.setAttribute("name","lineItems["+i+"][id]"),s.setAttribute("value",i);let d=document.createElement("input");d.setAttribute("type","hidden"),d.setAttribute("name","lineItems["+i+"][referencedId]"),d.setAttribute("value",i);let o=document.createElement("input");o.setAttribute("type","hidden"),o.setAttribute("name","lineItems["+i+"][type]"),o.setAttribute("value","product");let l=document.createElement("input");l.setAttribute("type","hidden"),l.setAttribute("name","lineItems["+i+"][stackable]"),l.setAttribute("value","1");let u=document.createElement("input");u.setAttribute("type","hidden"),u.setAttribute("name","lineItems["+i+"][removable]"),u.setAttribute("value","1");let c=document.createElement("input");c.setAttribute("type","hidden"),c.setAttribute("name","lineItems["+i+"][quantity]"),c.setAttribute("value","1");let h=document.createElement("input");h.setAttribute("type","hidden"),h.setAttribute("name","_csrf_token"),h.setAttribute("value",t.detail.csrfToken),r.appendChild(a),r.appendChild(n),r.appendChild(s),r.appendChild(d),r.appendChild(o),r.appendChild(l),r.appendChild(u),r.appendChild(c),r.appendChild(h);let m=t.detail.addToCartAction,p=e.serialize(r);this.$emitter.publish("beforeFormSubmit",p),this._openOffCanvasCarts(m,p)}_openOffCanvasCarts(e,i){let r=window.PluginManager.getPluginInstances("OffCanvasCart");t.iterate(r,t=>this._openOffCanvasCart(t,e,i))}_openOffCanvasCart(t,e,i){t.openOffCanvas(e,i,()=>{this.$emitter.publish("openOffCanvasCart")})}_fireEventTag(t){let{quantity:e,unitPrice:i,total:r}=t;tweakwiseLayer.push({event:"addtocart",data:{productKey:tweakwiseProductId,quantity:e,totalAmount:r}})}_extractAddToCartData(t){let e=t.querySelector('input[name^="lineItems["][name$="[quantity]"]'),i=1;e&&(Number.isNaN(i=parseInt(e.value||"1",10))||i<1)&&(i=1);let r=this._getUnitPriceFromDom(),a=null!==r?this._roundMoney(r*i):null;return{quantity:i,unitPrice:r,total:a}}_getUnitPriceFromDom(){let t=document.querySelector(".product-detail-price")||document.querySelector("[data-product-price]")||document.querySelector('meta[property="product:price:amount"]');if(!t)return null;let e=t.getAttribute("data-product-price");if(e&&!Number.isNaN(parseFloat(e)))return parseFloat(e);let i=t.getAttribute("content");if(i&&!Number.isNaN(parseFloat(i)))return parseFloat(i);let r=parseFloat((t.textContent||"").trim().replace(/\s/g,"").replace(/[^\d,.-]/g,"").replace(/\.(?=\d{3}(\D|$))/g,"").replace(",","."));return Number.isFinite(r)?r:null}_roundMoney(t){return Math.round((t+Number.EPSILON)*100)/100}}let a=window.PluginBaseClass;class n extends a{init(){"WishlistStorage"in window.PluginManager.getPluginList()&&(this.classList={isLoading:"product-wishlist-loading",addedState:"product-wishlist-added",notAddedState:"product-wishlist-not-added"},this._getWishlistStorage(),this._wishlistStorage||console.warn("No wishlist storage found"),this._registerEvents())}_registerEvents(){let t=this._navigationSuccess.bind(this),e=this._addToFavorites.bind(this),i=this._fireEventTag.bind(this);document.$emitter.subscribe("Wishlist/onProductsLoaded",()=>{wishlistProductsLoaded=!0}),window.addEventListener("twAddToFavorites",e),window.addEventListener("twInitFavorites",t),document.querySelector("button[data-add-to-wishlist]").addEventListener("click",i)}_navigationSuccess(t){if(t.detail.data.hasOwnProperty("items"))for(var e of t.detail.data.items)this._checkProductFavorite(e);if(t.detail.data.hasOwnProperty("groups"))for(var i of t.detail.data.groups)for(var e of i.items)this._checkProductFavorite(e)}_checkProductFavorite(t){let e=this._extractShopwareUUID(t.itemno);if(!e){console.log("Not a valid product id given",t.itemno);return}this._wishlistStorage.has(e)&&document.querySelectorAll(`[data-item-id="${t.itemno}"]`).forEach(t=>{t.classList.add("in-wishlist")})}_extractShopwareUUID(t){let e=t.match(/-([a-f0-9]{32})$/i);return e?e[1]:null}_addToFavorites(t){let e=this._extractShopwareUUID(t.detail.data.itemno);if(!e){console.log("Not a valid product id given",t.event.detail.itemno);return}let i={path:t.detail.routerAddPath.replace("idPlaceholder",e),afterLoginPath:t.detail.routerAddAfterLoginPath.replace("idPlaceholder",e)},r={path:t.detail.routerRemovePath.replace("idPlaceholder",e)};var a=document.querySelectorAll(`[data-item-id="${t.detail.data.itemno}"]`);this._wishlistStorage.has(e)?(this._wishlistStorage.remove(e,r),a.forEach(t=>{t.classList.remove("in-wishlist")})):(this._wishlistStorage.add(e,i),a.forEach(t=>{t.classList.add("in-wishlist")}))}_getWishlistStorage(){let t=document.querySelector("#wishlist-basket");t&&(this._wishlistStorage=window.PluginManager.getPluginInstanceFromElement(t,"WishlistStorage"),this._wishlistStorage.load())}_fireEventTag(){"undefined"!=typeof tweakwiseProductId&&tweakwiseProductId&&tweakwiseLayer.push({event:"addtowishlist",data:{productKey:tweakwiseProductId}})}}let s=window.PluginManager,d=s.getPluginList();try{(!1 in d||!s.getPlugin("TwAddToCartPlugin"))&&s.register("TwAddToCartPlugin",r)}catch(t){s.register("TwAddToCartPlugin",r)}try{(!1 in d||!s.getPlugin("TwAddToFavoritesPlugin"))&&s.register("TwAddToFavoritesPlugin",n)}catch(t){s.register("TwAddToFavoritesPlugin",n)}})();